## 寻路方案概述
- **入口/替换**：通过 Harmony 前缀拦截 `Actor.goTo`，改为异步提交 `PathFinder.RequestPath`。`updatePathMovement` 从 `PathStream` 流式消费结果，失败/中断即取消任务并停止行为。
- **任务与流**：每个单位一个 `PathfindingTask`（包含取消令牌、PathStream）。生成器在后台线程运行，路径结果按步写入流，主线程逐步读取以便边走边算。
- **生成器选择**：默认使用 `PortalAwarePathGenerator`，如未设置则回退到 `PassthroughPathGenerator`（仅写入目标单步）。
- **移动画像**：`MovementProfile.Build` 在锁内读取角色与配置，决定是否可走阻挡/熔岩/海洋、是否为船、速度倍率、最大 A* 节点数、最长可游宽度与超限惩罚。

## 算法设计（PortalAwarePathGenerator）
- **本地 A\***：对任意起点-终点先跑一次 A*（长距离上限节点数）。若成功即得到“直达”基线成本。
- **Portal 估算**：
  - 从注册表快照中取最近的入口（按起点距离，最多 `PortalCandidates`，默认 2），过滤超过 `PortalSearchRadius`（默认 64）。
  - 出口集合当前为全部门户（可按需再筛近目标集合）。
  - 对每条入口连接：估算成本 = 起点到入口的曼哈顿/步行速度 + 等待时间 + 传输时间 + 转运时间 + 出口到目标的曼哈顿/步行速度。
  - 记录为 `PortalEstimate`（不实际跑 A*）。
- **候选对比/延迟构建**：
  - 取估算成本最小的组合，与已有直达成本直接比较；若估算已不优于直达，则直接输出直达路径。
  - 仅对该最优估算组合执行真实 A*：起点→入口、出口→目标。两段都成功且真实成本优于当前最佳时，拼接三段路腿（移动-传送-移动）作为最终方案。
- **输出**：`EmitCandidate` 将路腿展开为步进。传送/乘船腿暂用 `Sail` 占位，由客户端或后续系统处理。

## 关键配置（PathfindingConfig 默认值）
- 范围与节点：`ShortRangeTiles=24`，`LongRangeTiles=96`，`MaxNodesShort=3000`，`MaxNodesLong=12000`。
- 水域限制：`MaxSwimWidth=12`，超限会追加惩罚 `LongSwimPenalty=2.5`。
- 门户搜索：`PortalCandidates=2`，`PortalSearchRadius=64`。
- 速度倍率：步行 0.4，游泳 0.25，航行 0.6（基于角色速度属性）。

## 门户与水域连通
- `PortalRegistry` 维护码头等门户快照；`WaterConnectivitySystem` 在并行 BFS 后用并查集合并组件，保持水域连通正确性。
- 事件驱动更新：
  - 建筑状态变更（码头建成/废墟/移除）会注册/移除门户并请求重建水连通。
  - 地图块脏检测（`MapChunkManager.updateDirty`）触发重建，确保大规模地形改动后的水路连通刷新。

## 地形突变的应对策略
- **行进步突变失效（面前变岩浆/起火/阻挡）**：
  - `updatePathMovement` 调用 `TryMove`；若步不可达则返回 `Abort`，当前寻路任务被取消，行为被中止。
  - **建议处理**：在行为层（调用 goTo 处或行为树）捕获 Abort 后，基于当前格重新发起 `goTo` 同目标，以便即时重算新路径。
- **水域/码头被毁**：
  - 码头状态变更会触发 `PortalRegistry` 更新与水连通重建，后续路径请求自动避开已失效门户。
  - 若单位正朝已毁码头移动，`TryMove` 会因阻挡/缺口返回 Abort，按上条策略重新发起路径即可。
- **航行/传送占位未落地**：
  - 传送腿目前以 `Sail` 占位；若目标出口周边地形突变（如被岩浆淹没），在出口附近会因步不可达而 Abort；同样需在行为层重发路径。
- **大范围地形刷新**：
  - 脏块更新会重建水连通，但正在执行的路径不会自动刷新；遇到阻断时依赖 Abort→重发路径的链路。

## 建议的防御性逻辑（可在调用层补充）
- 行为侧包装 `goTo`：失败或 `TryMove` Abort 时，延迟短时间重试（如 0.3s）并限制重试次数，避免震荡。
- 若需要更快收敛，可在 Abort 后先尝试短距离直达（短程 A*），失败再请求完整路径。
- 日志监控：结合 `PF_METRIC`（若开启）观察 Abort 频度与重试成功率，评估地形突变下的稳健性。

